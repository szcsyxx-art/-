{% extends "base.html" %}

{% block title %}æ³¨å†Œ - æˆ‘çš„ç½‘ç«™{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2 class="text-center mb-4">ç”¨æˆ·æ³¨å†Œ</h2>
        
        <form method="post" action="/register" id="registerForm">
            <!-- ç”¨æˆ·åè¾“å…¥ -->
            <div class="mb-3">
                <label for="username" class="form-label">ç”¨æˆ·å</label>
                <input
                    type="text" 
                    class="form-control bg-dark text-light border-secondary"
                    name="username" 
                    id="username"
                    placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                    required
                />
                <small id="usernameHelp" class="form-text text-muted">ç”¨æˆ·åé•¿åº¦3-20ä¸ªå­—ç¬¦</small>
            </div>

            <!-- å¯†ç è¾“å…¥ -->
            <div class="mb-3">
                <label for="password" class="form-label">å¯†ç </label>
                <input
                    type="password" 
                    class="form-control bg-dark text-light border-secondary"
                    name="pwd" 
                    id="password"
                    placeholder="è¯·è¾“å…¥å¯†ç "
                    required
                />
                <small id="passwordHelp" class="form-text text-muted">å¯†ç å¿…é¡»ä¸å°‘äº8ä½</small>
            </div>

            <!-- ç¡®è®¤å¯†ç  -->
            <div class="mb-3">
                <label for="confirm_password" class="form-label">ç¡®è®¤å¯†ç </label>
                <input
                    type="password" 
                    class="form-control bg-dark text-light border-secondary"
                    name="confirm_pwd" 
                    id="confirm_password"
                    placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                    required
                />
                <small id="confirmPasswordHelp" class="form-text text-muted">è¯·å†æ¬¡è¾“å…¥å¯†ç ç¡®ä¿ä¸€è‡´</small>
            </div>
                    
            <!-- æäº¤æŒ‰é’® -->
            <button type="submit" class="btn btn-primary w-100">æ³¨å†Œè´¦å·</button>
            <span style="color:red;">{{error}}</span>
                    
            <!-- ç™»å½•é“¾æ¥ -->
            <div class="text-center mt-3">
                <a href="/login" class="text-light">å·²æœ‰è´¦å·ï¼Ÿç«‹å³ç™»å½•</a>
            
            {% if error %}
                <div class="alert alert-danger mt-3">{{ error }}</div>
            {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- JavaScriptä»£ç ä¿æŒä¸å˜ -->
<!-- å®æ—¶éªŒè¯JavaScript -->
<script>
    // è·å–æ‰€æœ‰è¾“å…¥æ¡†å’Œæç¤ºå…ƒç´ 
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const usernameHelp = document.getElementById('usernameHelp');
    const passwordHelp = document.getElementById('passwordHelp');
    const confirmPasswordHelp = document.getElementById('confirmPasswordHelp');
    const registerForm = document.getElementById('registerForm');

    // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
    let checkUsernameTimeout;
    function debounceCheckUsername(username) {
        clearTimeout(checkUsernameTimeout);
        checkUsernameTimeout = setTimeout(() => {
            checkUsernameAvailability(username);
        }, 500); // ç”¨æˆ·åœæ­¢è¾“å…¥500msåæ£€æŸ¥
    }

    // æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§
    function checkUsernameAvailability(username) {
        if (username.length < 3 || username.length > 20) {
            return; // é•¿åº¦ä¸ç¬¦åˆè¦æ±‚ï¼Œä¸æ£€æŸ¥
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        usernameHelp.innerHTML = 'ğŸ” æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§...';
        usernameHelp.className = 'form-text text-warning';

        // å‘é€AJAXè¯·æ±‚åˆ°åç«¯
        fetch('/api/check_username', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: username })
        })
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                usernameHelp.innerHTML = 'âœ… ç”¨æˆ·åå¯ç”¨';
                usernameHelp.className = 'form-text text-success';
            } else {
                usernameHelp.innerHTML = data.message;
                usernameHelp.className = 'form-text text-danger';
            }
        })
        .catch(error => {
            console.error('æ£€æŸ¥ç”¨æˆ·åæ—¶å‡ºé”™:', error);
            usernameHelp.innerHTML = 'âš ï¸ æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•';
            usernameHelp.className = 'form-text text-warning';
        });
    }

    // ç”¨æˆ·åå®æ—¶éªŒè¯
    usernameInput.addEventListener('input', function() {
        const username = this.value;
            
        if (username.length === 0) {
            usernameHelp.innerHTML = 'è¯·è¾“å…¥ç”¨æˆ·å';
            usernameHelp.className = 'form-text text-muted';
        } else if (username.length < 3) {
            usernameHelp.innerHTML = 'âŒ ç”¨æˆ·åå¤ªçŸ­ï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰';
            usernameHelp.className = 'form-text text-danger';
        } else if (username.length > 20) {
            usernameHelp.innerHTML = 'âŒ ç”¨æˆ·åå¤ªé•¿ï¼ˆæœ€å¤š20ä¸ªå­—ç¬¦ï¼‰';
            usernameHelp.className = 'form-text text-danger';
        } else {
            usernameHelp.innerHTML = 'âœ… ç”¨æˆ·åæ ¼å¼æ­£ç¡®ï¼Œæ£€æŸ¥å¯ç”¨æ€§...';
            usernameHelp.className = 'form-text text-success';
            // ğŸ†• è§¦å‘ç”¨æˆ·åå¯ç”¨æ€§æ£€æŸ¥
            debounceCheckUsername(username);
        }
    });

    // å¯†ç å®æ—¶éªŒè¯
    passwordInput.addEventListener('input', function() {
        const password = this.value;
            
        if (password.length === 0) {
            passwordHelp.innerHTML = 'è¯·è¾“å…¥å¯†ç ';
            passwordHelp.className = 'form-text text-muted';
        } else if (password.length < 8) {
            passwordHelp.innerHTML = 'âŒ å¯†ç å¤ªçŸ­ï¼ˆè‡³å°‘8ä¸ªå­—ç¬¦ï¼‰';
            passwordHelp.className = 'form-text text-danger';
        } else {
            passwordHelp.innerHTML = 'âœ… å¯†ç é•¿åº¦ç¬¦åˆè¦æ±‚';
            passwordHelp.className = 'form-text text-success';
        }
            
        // è§¦å‘ç¡®è®¤å¯†ç çš„é‡æ–°éªŒè¯
        confirmPasswordInput.dispatchEvent(new Event('input'));
    });

    // ç¡®è®¤å¯†ç å®æ—¶éªŒè¯
    confirmPasswordInput.addEventListener('input', function() {
        const password = passwordInput.value;
        const confirmPassword = this.value;
            
        if (confirmPassword.length === 0) {
            confirmPasswordHelp.innerHTML = 'è¯·å†æ¬¡è¾“å…¥å¯†ç ';
            confirmPasswordHelp.className = 'form-text text-muted';
        } else if (password !== confirmPassword) {
            confirmPasswordHelp.innerHTML = 'âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
            confirmPasswordHelp.className = 'form-text text-danger';
        } else if (password.length >= 8) {
            confirmPasswordHelp.innerHTML = 'âœ… å¯†ç ä¸€è‡´';
            confirmPasswordHelp.className = 'form-text text-success';
        } else {
            confirmPasswordHelp.innerHTML = 'âš ï¸ å¯†ç ä¸€è‡´ï¼Œä½†ä¸»å¯†ç é•¿åº¦ä¸è¶³';
            confirmPasswordHelp.className = 'form-text text-warning';
        }
    });

    // è¡¨å•æäº¤å‰çš„æœ€ç»ˆéªŒè¯
    registerForm.addEventListener('submit', function(e) {
        const username = usernameInput.value;
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        let isValid = true;

        submitButton.disabled = true;
        submitButton.innerHTML = 
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> å¤„ç†ä¸­...';

        // éªŒè¯ç”¨æˆ·å
        if (username.length < 3 || username.length > 20) {
            usernameHelp.innerHTML = 'âŒ ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´';
            usernameHelp.className = 'form-text text-danger';
            isValid = false;
        }

        // éªŒè¯å¯†ç 
        if (password.length < 8) {
            passwordHelp.innerHTML = 'âŒ å¯†ç å¿…é¡»ä¸å°‘äº8ä½';
            passwordHelp.className = 'form-text text-danger';
            isValid = false;
        }

        // éªŒè¯å¯†ç ä¸€è‡´æ€§
        if (password !== confirmPassword) {
            confirmPasswordHelp.innerHTML = 'âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
            confirmPasswordHelp.className = 'form-text text-danger';
            isValid = false;
        }

        // å¦‚æœéªŒè¯ä¸é€šè¿‡ï¼Œé˜»æ­¢è¡¨å•æäº¤
        if (!isValid) {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
            e.preventDefault();
            alert('è¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦æ­£ç¡®ï¼');
        }
    });

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æç¤º
    usernameHelp.innerHTML = 'ç”¨æˆ·åé•¿åº¦3-20ä¸ªå­—ç¬¦';
    passwordHelp.innerHTML = 'å¯†ç å¿…é¡»ä¸å°‘äº8ä½';
    confirmPasswordHelp.innerHTML = 'è¯·å†æ¬¡è¾“å…¥å¯†ç ç¡®ä¿ä¸€è‡´';


    // åœ¨æ³¨å†Œé¡µé¢çš„å¯†ç éªŒè¯ä¸­æ·»åŠ å¼ºåº¦æ£€æŸ¥
    function checkPasswordStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
    
        return strength;
    }

    // åœ¨å¯†ç è¾“å…¥äº‹ä»¶ä¸­
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);
    
        // æ ¹æ®å¼ºåº¦æ˜¾ç¤ºä¸åŒæç¤º
        const messages = ['', 'å¼±', 'ä¸€èˆ¬', 'è‰¯å¥½', 'å¼º', 'å¾ˆå¼º'];
        const colors = ['muted', 'danger', 'warning', 'info', 'success', 'success'];
    
        if (password.length === 0) {
            passwordHelp.innerHTML = 'è¯·è¾“å…¥å¯†ç ';
            passwordHelp.className = 'form-text text-muted';
        } else if (password.length < 8) {
            passwordHelp.innerHTML = 'âŒ å¯†ç å¤ªçŸ­ï¼ˆè‡³å°‘8ä¸ªå­—ç¬¦ï¼‰';
            passwordHelp.className = 'form-text text-danger';
        } else {
            passwordHelp.innerHTML = `âœ… å¯†ç å¼ºåº¦ï¼š${messages[strength]}`;
            passwordHelp.className = `form-text text-${colors[strength]}`;
        }
    });
</script>
{% endblock %}
